
{% extends "maintemplate.html" %}

{% block title %}Discover{% endblock %}

{% block style %}

<style type="text/css">
	.library-button {
		margin-bottom: 10px;
	}
	
	.library-dropdown {
		margin-top: -10px;
	}
	
	.notInNetwork {
		display: none;
	}
</style>

{% endblock %}

{% block script %}

<script src="{{ url_for('static', filename='js/jquery.cookie.js') }}"></script>

<script type="text/javascript">
	
	$(function() {
		$(".tooltip-button").tooltip({trigger: "hover"});
	});
	
	function add_book(book_type, bookOLKey, book_key){
		//disable button and caret
		$("#add_button" + book_key).attr("disabled", "disabled");
		$("#caret_button" + book_key).attr("disabled", "disabled");
		$.post("/library/" + book_type + "/" + bookOLKey, function(data) {
			//update text to In Library and update link to library
			//the link doesn't work as a href because it's a button, not an "a"
			$("#add_button" + book_key).text("In Library");
			$("#add_button" + book_key).removeAttr("onclick");
			$("#add_button" + book_key).attr("href", "\library");
			//update color to primary
			$("#add_button" + book_key).removeClass("btn-inverse").addClass("btn-primary");
			$("#caret_button" + book_key).removeClass("btn-inverse").addClass("btn-primary");
			//update tooltip
			$("#add_button" + book_key).tooltip("destroy").attr("title", "Book is already in your library. Click to view library.").tooltip({trigger: "hover"});
			//remove entry of item type clicked
			$("#add_" + book_type + book_key).hide();
			//enable button and caret
			$("#add_button" + book_key).removeAttr("disabled");
			$("#caret_button" + book_key).removeAttr("disabled");
		}).error(function() {
			$("#add_button" + book_key).removeAttr("disabled");
		});
		
		return false;
	}
	
	function request_book(bookOLKey, title, button){
		$(button).attr("disabled", "disabled");
		$.getJSON("/search/inNetwork/" + bookOLKey, function(data) {
			$(button).removeAttr("disabled");
			$('#borrowTable').empty();
			$.each(data, function(key, val) {
				
				var link = $('<a>', {
					'class': 'btn btn-inverse',
					onclick: 'borrow_book("' + val.bookCopyID + '", "' + key + '", this, "' + title + '", "' + val.username + '")',
					html: 'Request to Borrow'
				});
				if(!val.available) {
					link.attr("disabled", "");
				}
				
				$('#borrowTable')
				.append(
					$('<tr>')
					.append(
						$('<td>', {
							html: val.username
						}))
					.append(
						$('<td>')
						.append(
							link
						)
					)
				);
			});
			$("#borrowModal").modal('show');
		}).error(function() {
			$(button).removeAttr("disabled");
		});
		
		return false;
	}
	
	function borrow_book(bookCopyID, lenderID, button, bookTitle, lenderName) {
		$(button).attr("disabled", "disabled");
		$.getJSON("/setup_book_borrow/" + lenderID + "/" + bookCopyID, function(data) {
			$("#borrowModal").modal('hide');
			$("#messageBook").text(bookTitle);
			$("#messageUser").text(lenderName);
			$("#message").show();
		});
	}
	
	function hide_message() {
		$("#message").hide();
		return false;
	}
	
</script>

{% endblock %}
		
{% block content %}

<div class="row" style="position: relative;">
	<div class="span6 offset3" style="position: absolute; top: 10px;">
		<div id="message" class="alert" style="display: none;">
			<a class="close" onclick="hide_message()">&times;</a>
			You have requested to borrow <span id="messageBook"></span> from <span id="messageUser"></span>.
		</div>
	</div>
</div>

<div id="borrowModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="borrowModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3 id="borrowModalLabel">Users Who Have This Book</h3>
  </div>
  <div class="modal-body">
    <table id="borrowTable" class="table">
	</table>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
  </div>
</div>

<div class="row">
	<div class="span12">
		<h3>Browse Books in Your Network</h3>
	</div>
</div>
<br>
<div class="row-fluid">
	<div class="span1">
	</div>
	<div class="span10">
		
		<table class="table">
			{% if itemlist | length < 1 %}
				<tr><td>There are no books available in your network.</td></tr>
			{% else %}
				{% for item in itemlist %}
				<tr>
					<td style="width:100px"><img {% if item.thumbnail_link == "" %}src="{{ url_for('static', filename='img/nocoverart.png') }}"
								{% else %}src="{{ item.thumbnail_link }}"{% endif %} 
								style="height:auto;width:100px;"/></td>
					<td>
							Title: {{ item.title }}<br/>
							Author: {{ item.author }}
					</td>
					<td style="width: 150px">
						<div class="btn-group">
						  <button class="btn btn-{% if item.inLibrary == [] %}inverse{% else %}primary{% endif %} tooltip-button library-button"
							style="width:120px"
							{% if user.is_authenticated() == False %}disabled{% endif %} 
							onclick="{% if user.is_authenticated() and item.inLibrary == [] %}add_book('book', '{{ item.OLKey }}', 'book{{ book }}'){% endif %}" 
							title="{% if item.inLibrary == [] %}{% if user.is_authenticated() %}Add to library and make available to your network{% 
							else %}Join or login to add to your library{% endif %}{% else %}Book is already in your library. Click to view library.{% endif %}"
							id="add_button{{ book }}">{% if item.inLibrary == [] %}Add&nbsp;to&nbsp;Library{% else %}In&nbsp;Library{% endif %}</button>
						  <button class="btn btn-{% if item.inLibrary == [] %}inverse{% else %}primary{% endif %} dropdown-toggle library-button" data-toggle="dropdown" id="caret_button{{ book }}">
							<span class="caret"></span>
						  </button>
						  {% if item.inLibrary != ['book', 'ebook', 'audiobook'] %}
						  <ul class="dropdown-menu library-dropdown">
							{% if 'book' not in item.inLibrary %}<li><a id="add_book{{ book }}" onclick="{% if user.is_authenticated() %}add_book('book', '{{ item.OLKey }}', '{{ book }}'){% endif %}">Add&nbsp;Book&nbsp;to&nbsp;Library</a></li>{% endif %}
							{% if 'ebook' not in item.inLibrary %}<li><a id="add_ebook{{ book }}" onclick="{% if user.is_authenticated() %}add_book('ebook', '{{ item.OLKey }}', '{{ book }}'){% endif %}">Add&nbsp;eBook&nbsp;to&nbsp;Library</a></li>{% endif %}
							{% if 'audiobook' not in item.inLibrary %}<li><a id="add_audiobook{{ book }}" onclick="{% if user.is_authenticated() %}add_book('audiobook', '{{ item.OLKey }}', '{{ book }}'){% endif %}">Add&nbsp;Audiobook&nbsp;to&nbsp;Library</a></li>{% endif %}
						  </ul>
						  {% endif %}
						</div>
						<a class="btn tooltip-button"
							style="width:120px" 
							{% if user.is_authenticated() == False %}disabled{% endif %}
							onclick="{% if user.is_authenticated() %}request_book('{{ item.OLKey }}', '{{ item.escapedtitle }}', this){% endif %}"
							data-toggle="tooltip" data-placement="right"
							title="{% if user.is_authenticated() %}Request to borrow book from one of your connections{% 
							else %}Join or login to request to borrow books{% endif %}">Request&nbsp;to&nbsp;Borrow</a>
					</td>
				</tr>
				{% endfor %}
			{% endif %}
		</table
	</div>
</div>

{% endblock %}
